import asyncio
import os
import json
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import CommandStart
from aiogram.types import (
    ReplyKeyboardMarkup, KeyboardButton,
    InlineKeyboardMarkup, InlineKeyboardButton, InputFile
)
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from cryptography.fernet import Fernet

DB_FILE = "/data/clients_db.json"
KEY_FILE = "/data/secret.key"
BACKUP_DIR = "/data/backups"
os.makedirs(BACKUP_DIR, exist_ok=True)
API_TOKEN = "7636123092:AAEAnU8iuShy7UHjH2cwzt1vRA-Pl3e3od8"
ADMIN_ID = 350902460

# --- –®–ò–§–†–û–í–ê–ù–ò–ï –ë–î –ò –ë–≠–ö–ê–ü ---
def generate_key():
    if not os.path.exists(KEY_FILE):
        key = Fernet.generate_key()
        with open(KEY_FILE, "wb") as f:
            f.write(key)

def load_key():
    with open(KEY_FILE, "rb") as f:
        return f.read()

def encrypt_data(data: str, key: bytes) -> bytes:
    return Fernet(key).encrypt(data.encode())

def decrypt_data(token: bytes, key: bytes) -> str:
    return Fernet(key).decrypt(token).decode()

generate_key()
ENCRYPT_KEY = load_key()

def load_db():
    if not os.path.exists(DB_FILE):
        return []
    with open(DB_FILE, "rb") as f:
        try:
            encrypted = f.read()
            if not encrypted:
                return []
            decrypted = decrypt_data(encrypted, ENCRYPT_KEY)
            return json.loads(decrypted)
        except Exception:
            return []

def save_db(data):
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "rb") as orig, open(DB_FILE + "_backup", "wb") as backup:
            backup.write(orig.read())
    encrypted = encrypt_data(json.dumps(data, ensure_ascii=False, indent=2), ENCRYPT_KEY)
    with open(DB_FILE, "wb") as f:
        f.write(encrypted)

def backup_db():
    now = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = os.path.join(BACKUP_DIR, f"clients_db_{now}.json")
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "rb") as src, open(backup_path, "wb") as dst:
            dst.write(src.read())
    return backup_path

def list_backups():
    return sorted([f for f in os.listdir(BACKUP_DIR) if f.startswith("clients_db_") and f.endswith(".json")])

def restore_db(backup_name):
    backup_path = os.path.join(BACKUP_DIR, backup_name)
    if os.path.exists(backup_path):
        with open(backup_path, "rb") as src, open(DB_FILE, "wb") as dst:
            dst.write(src.read())
        return True
    return False

def get_next_client_id(clients):
    if not clients: return 1
    return max(c["id"] for c in clients) + 1

def find_clients(query):
    clients = load_db()
    results = []
    q = query.lower()
    for c in clients:
        if (q in str(c.get("contact", "")).lower() or
            q in str(c.get("birth_date", "")).lower() or
            q in str(c.get("region", "")).lower() or
            q in str(c.get("console", "")).lower() or
            any(q in str(val).lower() for val in c.get("games", [])) or
            q in str(c.get("account", {}).get("login", "")).lower() or
            q in str(c.get("account", {}).get("password", "")).lower() or
            q in str(c.get("account", {}).get("mail_pass", "")).lower() or
            any(q in str(sub.get("name", "")).lower() or q in str(sub.get("duration", "")).lower() for sub in c.get("subscriptions", []))
        ):
            results.append(c)
    return results

def find_clients_no_subscription():
    clients = load_db()
    results = []
    for c in clients:
        subs = c.get("subscriptions", [])
        if not subs or (len(subs) == 1 and subs[0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"):
            results.append(c)
    return results

def save_new_client(client):
    clients = load_db()
    clients.append(client)
    save_db(clients)

def update_client(client):
    clients = load_db()
    for i, c in enumerate(clients):
        if c["id"] == client["id"]:
            clients[i] = client
            save_db(clients)
            return
    clients.append(client)
    save_db(clients)

def delete_client(client_id):
    clients = load_db()
    clients = [c for c in clients if c["id"] != client_id]
    save_db(clients)

# --- FSM STATES ---
class AddEditClient(StatesGroup):
    contact = State()
    birthdate_yesno = State()
    birthdate = State()
    account = State()
    region = State()
    console = State()
    subscriptions_yesno = State()
    subscriptions_count = State()
    sub_1_type = State()
    sub_1_duration = State()
    sub_1_start = State()
    sub_2_type = State()
    sub_2_duration = State()
    sub_2_start = State()
    games_yesno = State()
    games_input = State()
    reserve_yesno = State()
    reserve_photo = State()
    final_card = State()
    edit_choose = State()
    edit_input = State()
    edit_games = State()
    edit_subs = State()
    edit_reserve = State()
    awaiting_confirm = State()
    awaiting_confirm_restore = State()
    edit_subs_master = State()
    edit_subs_total = State()
    edit_sub_1_type = State()
    edit_sub_1_duration = State()
    edit_sub_1_start = State()
    edit_sub_2_type = State()
    edit_sub_2_duration = State()
    edit_sub_2_start = State()
    awaiting_db_confirm = State()

# --- –ö–ù–û–ü–ö–ò ---
def region_btns():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="—É–∫—Ä"), KeyboardButton(text="—Ç—É—Ä")],
            [KeyboardButton(text="(–ø–æ–ª—å—à–∞)"), KeyboardButton(text="(–±—Ä–∏—Ç–∞–Ω–∏—è)")],
            [KeyboardButton(text="–¥—Ä—É–≥–æ–π")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True
    )

def console_btns():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="PS4"), KeyboardButton(text="PS5")],
            [KeyboardButton(text="PS4/PS5")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True
    )

def edit_keyboard(client):
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üì± –ù–æ–º–µ—Ä/TG", callback_data=f"edit_contact_{client['id']}"),
            InlineKeyboardButton(text="üîê –î–∞–Ω–Ω—ã–µ", callback_data=f"edit_account_{client['id']}"),
        ],
        [
            InlineKeyboardButton(text="üí≥ –ü–æ–¥–ø–∏—Å–∫–∞", callback_data=f"edit_sub_{client['id']}"),
            InlineKeyboardButton(text="üé≤ –ò–≥—Ä—ã", callback_data=f"edit_games_{client['id']}"),
        ],
        [
            InlineKeyboardButton(text="üñº –†–µ–∑. –∫–æ–¥—ã", callback_data=f"edit_reserve_{client['id']}"),
            InlineKeyboardButton(text="üéÆ –ö–æ–Ω—Å–æ–ª—å", callback_data=f"edit_console_{client['id']}"),
        ],
        [
            InlineKeyboardButton(text="üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥.", callback_data=f"edit_birth_{client['id']}"),
            InlineKeyboardButton(text="üåç –†–µ–≥–∏–æ–Ω", callback_data=f"edit_region_{client['id']}"),
        ],
        [
            InlineKeyboardButton(text="‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data=f"save_{client['id']}")
        ]
    ])

def main_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞")],
            [KeyboardButton(text="üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞")],
            [KeyboardButton(text="üìä –ë–∞–∑–∞")]
        ], resize_keyboard=True
    )

def base_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)"), KeyboardButton(text="–°–∫–æ—Ä–æ –î–† (7–¥)")],
            [KeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏"), KeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç")],
            [KeyboardButton(text="–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã"), KeyboardButton(text="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞")],
            [KeyboardButton(text="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É"), KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True
    )

def format_card(client, show_photo_id=False):
    lines = []
    contact = client.get("contact", "‚Äî")
    bdate = client.get("birth_date", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    console = client.get("console", "‚Äî")
    lines.append(f"<b>{contact}</b> | {bdate} ({console})")
    acc = client.get("account", {})
    login = acc.get("login", "")
    password = acc.get("password", "")
    mail_pass = acc.get("mail_pass", "")
    if login:
        lines.append(f"üîê <b>{login}</b>; {password}")
    if mail_pass:
        lines.append(f"‚úâÔ∏è –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å: {mail_pass}")
    else:
        lines.append(f"‚úâÔ∏è –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å:")
    subs = client.get("subscriptions", [])
    for sub in subs:
        if sub.get("name") != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
            lines.append(f"\n<b>üóì {sub.get('name', '')} {sub.get('duration', '')}</b>")
            lines.append(f"üìÖ {sub.get('start', '')} ‚Üí {sub.get('end', '')}")
    if subs and subs[0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
        lines.append(f"\n<b>–ü–æ–¥–ø–∏—Å–∫–∞:</b> –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    region = client.get("region", "‚Äî")
    lines.append(f"\nüåç –†–µ–≥–∏–æ–Ω: {region}")
    games = client.get("games", [])
    if games:
        lines.append("\nüéÆ –ò–≥—Ä—ã:")
        for game in games:
            lines.append(f"‚Ä¢ {game}")
    reserve_photo_id = client.get("reserve_photo_id")
    return "\n".join(lines), reserve_photo_id if show_photo_id else None

def stats_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)", callback_data="expiring_subs"),
            InlineKeyboardButton(text="–°–∫–æ—Ä–æ –î–† (7–¥)", callback_data="upcoming_birthdays"),
        ],
        [
            InlineKeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏", callback_data="no_subscription"),
            InlineKeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç", callback_data="dump_all"),
        ],
        [
            InlineKeyboardButton(text="–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã", callback_data="do_backup"),
            InlineKeyboardButton(text="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞", callback_data="restore_backup"),
        ],
        [
            InlineKeyboardButton(text="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É", callback_data="clear_db"),
            InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_base"),
        ]
    ])

# --- –ß–ò–°–¢–ö–ê –ß–ê–¢–ê ---
async def clear_chat(message: types.Message):
    try:
        chat = message.chat.id
        async for msg in bot.get_chat_history(chat, limit=100):
            try:
                await bot.delete_message(chat, msg.message_id)
            except:
                continue
    except:
        pass

# --- –°–¢–ê–†–¢ ---
bot = Bot(
    token=API_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()
scheduler = AsyncIOScheduler()

@dp.message(CommandStart())
async def start_cmd(message: types.Message, state: FSMContext):
    if message.from_user.id != ADMIN_ID:
        await message.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return
    await state.clear()
    await clear_chat(message)
    await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", reply_markup=main_menu())

# --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê ---
@dp.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞")
async def add_start(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ Telegram (@username):",
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.contact)

@dp.message(AddEditClient.contact)
async def step_contact(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    await state.update_data(contact=message.text.strip())
    await message.answer("–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –µ—Å—Ç—å?",
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
    await state.set_state(AddEditClient.birthdate_yesno)

@dp.message(AddEditClient.birthdate_yesno)
async def step_birthdate_ask(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(birth_date="–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        await ask_account(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):",
            reply_markup=ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.birthdate)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.birthdate)
async def step_birthdate(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    try:
        datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    await state.update_data(birth_date=message.text.strip())
    await ask_account(message, state)

async def ask_account(message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏:\n1. –õ–æ–≥–∏–Ω\n2. –ü–∞—Ä–æ–ª—å\n3. –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)\n\n–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.account)

@dp.message(AddEditClient.account)
async def step_account(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    rows = message.text.strip().split("\n")
    login = rows[0].strip() if len(rows) > 0 else ""
    password = rows[1].strip() if len(rows) > 1 else ""
    mail_pass = rows[2].strip() if len(rows) > 2 else ""
    await state.update_data(account={"login": login, "password": password, "mail_pass": mail_pass})
    await message.answer("–í—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞:", reply_markup=region_btns())
    await state.set_state(AddEditClient.region)

@dp.message(AddEditClient.region)
async def step_region(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text not in ("—É–∫—Ä", "—Ç—É—Ä", "–¥—Ä—É–≥–æ–π", "(–ø–æ–ª—å—à–∞)", "(–±—Ä–∏—Ç–∞–Ω–∏—è)"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(region=message.text)
    await message.answer("–ö–∞–∫–∞—è –∫–æ–Ω—Å–æ–ª—å?", reply_markup=console_btns())
    await state.set_state(AddEditClient.console)

@dp.message(AddEditClient.console)
async def step_console(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text not in ("PS4", "PS5", "PS4/PS5"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(console=message.text)
    await message.answer("–ï—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.subscriptions_yesno)

@dp.message(AddEditClient.subscriptions_yesno)
async def step_subs_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(subscriptions=[{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}])
        await ask_games(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–°–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫?", reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–û–¥–Ω–∞"), KeyboardButton(text="–î–≤–µ")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
        await state.set_state(AddEditClient.subscriptions_count)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.subscriptions_count)
async def step_subs_count(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–û–¥–Ω–∞":
        await state.update_data(subs_total=1)
        await sub_select(message, state, sub_num=1, only_one=True)
        return
    if message.text == "–î–≤–µ":
        await state.update_data(subs_total=2)
        await sub_select(message, state, sub_num=1, only_one=False)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

async def sub_select(message, state: FSMContext, sub_num=1, only_one=False):
    if sub_num == 1:
        kb = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra")],
                [KeyboardButton(text="PS Plus Essential"), KeyboardButton(text="EA Play")],
                [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True
        )
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=kb)
        await state.set_state(AddEditClient.sub_1_type)
    else:
        data = await state.get_data()
        prev = data.get("sub_1_type")
        kb = None
        if prev == "EA Play":
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra"), KeyboardButton(text="PS Plus Essential")],
                    [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        else:
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="EA Play")],
                    [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=kb)
        await state.set_state(AddEditClient.sub_2_type)

@dp.message(AddEditClient.sub_1_type)
async def sub1_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        await state.update_data(subscriptions=[{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}])
        await ask_games(message, state)
        return
    if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential", "EA Play"):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_1_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.sub_1_duration)

@dp.message(AddEditClient.sub_1_duration)
async def sub1_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    data = await state.get_data()
    sub_1_type = data.get("sub_1_type")
    if (sub_1_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_1_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_1_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.sub_1_start)

@dp.message(AddEditClient.sub_1_start)
async def sub1_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("sub_1_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("sub_1_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    await state.update_data(sub_1=sub)
    subs_total = data.get("subs_total", 1)
    if subs_total == 2:
        await sub_select(message, state, sub_num=2)
    else:
        await state.update_data(subscriptions=[sub])
        await ask_games(message, state)

@dp.message(AddEditClient.sub_2_type)
async def sub2_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        data = await state.get_data()
        await state.update_data(subscriptions=[data.get("sub_1")])
        await ask_games(message, state)
        return
    data = await state.get_data()
    prev = data.get("sub_1_type")
    if prev == "EA Play":
        if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential"):
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ PS Plus!")
            return
    else:
        if message.text != "EA Play":
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ EA Play!")
            return
    await state.update_data(sub_2_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.sub_2_duration)

@dp.message(AddEditClient.sub_2_duration)
async def sub2_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    data = await state.get_data()
    sub_2_type = data.get("sub_2_type")
    if (sub_2_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_2_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_2_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.sub_2_start)

@dp.message(AddEditClient.sub_2_start)
async def sub2_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("sub_2_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("sub_2_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    subs = [data.get("sub_1"), sub]
    await state.update_data(sub_2=sub, subscriptions=subs)
    await ask_games(message, state)

# --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò–ì–†–´, –†–ï–ó–ï–†–í–ù–´–ï –ö–û–î–´, –§–ò–ù–ê–õ ---

async def ask_games(message, state: FSMContext):
    await message.answer("–û—Ñ–æ—Ä–º–ª–µ–Ω—ã –∏–≥—Ä—ã?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.games_yesno)

@dp.message(AddEditClient.games_yesno)
async def games_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(games=[])
        await ask_reserve(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–í–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):",
            reply_markup=ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.games_input)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.games_input)
async def games_input(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    games = [line.strip() for line in message.text.strip().split("\n") if line.strip()]
    await state.update_data(games=games)
    await ask_reserve(message, state)

async def ask_reserve(message, state: FSMContext):
    await message.answer("–ï—Å—Ç—å –ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.reserve_yesno)

@dp.message(AddEditClient.reserve_yesno)
async def reserve_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(reserve_photo_id=None)
        await finish_client(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç (—Ñ–æ—Ç–æ):", reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.reserve_photo)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.reserve_photo)
async def reserve_photo(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.photo:
        file_id = message.photo[-1].file_id
        await state.update_data(reserve_photo_id=file_id)
        await finish_client(message, state)
    else:
        await message.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ!")

async def finish_client(message: types.Message, state: FSMContext):
    data = await state.get_data()
    client = {
        "id": get_next_client_id(load_db()),
        "contact": data.get("contact", ""),
        "birth_date": data.get("birth_date", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"),
        "account": data.get("account", {}),
        "region": data.get("region", ""),
        "console": data.get("console", ""),
        "subscriptions": data.get("subscriptions", [{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}]),
        "games": data.get("games", []),
        "reserve_photo_id": data.get("reserve_photo_id", None),
    }
    save_new_client(client)
    await state.clear()
    await clear_chat(message)
    if client.get("reserve_photo_id"):
        await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0], reply_markup=edit_keyboard(client))
    else:
        await message.answer(format_card(client)[0], reply_markup=edit_keyboard(client))
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ (–Ω–µ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª!)

# --- –ü–û–ò–°–ö –ö–õ–ò–ï–ù–¢–ê ---
@dp.message(F.text == "üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞")
async def search_start(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ (–Ω–æ–º–µ—Ä, –ª–æ–≥–∏–Ω, –∏–≥—Ä–∞ –∏ —Ç.–¥.):",
        reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_choose)

@dp.message(AddEditClient.edit_choose)
async def search_choose(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    query = message.text.strip()
    clients = find_clients(query)
    if not clients:
        await message.answer("–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await start_cmd(message, state)
        return
    await state.clear()
    await clear_chat(message)
    for client in clients:
        if client.get("reserve_photo_id"):
            await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0], reply_markup=edit_keyboard(client))
        else:
            await message.answer(format_card(client)[0], reply_markup=edit_keyboard(client))

# --- –ò–ù–õ–ê–ô–ù-–ö–ù–û–ü–ö–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
@dp.callback_query(F.data.startswith("edit_"))
async def edit_fields(callback: types.CallbackQuery, state: FSMContext):
    act, field, cid = callback.data.split("_", 2)
    cid = int(cid)
    clients = load_db()
    client = next((c for c in clients if c["id"] == cid), None)
    if not client:
        await callback.message.answer("–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    await state.clear()
    await state.update_data(edit_id=cid)
    if field == "contact":
        await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ Telegram:", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="contact")
        return
    if field == "birth":
        await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥) –∏–ª–∏ '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç':", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="birth_date")
        return
    if field == "account":
        await callback.message.answer("–í–≤–µ–¥–∏:\n1. –õ–æ–≥–∏–Ω\n2. –ü–∞—Ä–æ–ª—å\n3. –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)\n\n–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
            reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="account")
        return
    if field == "console":
        await callback.message.answer("–í—ã–±–µ—Ä–∏ –∫–æ–Ω—Å–æ–ª—å:", reply_markup=console_btns())
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="console")
        return
    if field == "region":
        await callback.message.answer("–í—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞:", reply_markup=region_btns())
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="region")
        return
    if field == "reserve":
        await callback.message.answer("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ —Ä–µ–∑–µ—Ä–≤-–∫–æ–¥–æ–≤:", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_reserve)
        return
    if field == "sub":
        await callback.message.answer("–°–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫?", reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–û–¥–Ω–∞"), KeyboardButton(text="–î–≤–µ")],
                [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_subs_total)
        return
    if field == "games":
        await callback.message.answer("–í–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_games)
        return

# --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–õ–ï–ô ---
@dp.message(AddEditClient.edit_input)
async def edit_input_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    data = await state.get_data()
    cid = data.get("edit_id")
    field = data.get("edit_field")
    clients = load_db()
    for i, c in enumerate(clients):
        if c["id"] == cid:
            if field == "contact":
                c["contact"] = message.text.strip()
            elif field == "birth_date":
                c["birth_date"] = message.text.strip()
            elif field == "account":
                rows = message.text.strip().split("\n")
                login = rows[0].strip() if len(rows) > 0 else ""
                password = rows[1].strip() if len(rows) > 1 else ""
                mail_pass = rows[2].strip() if len(rows) > 2 else ""
                c["account"] = {"login": login, "password": password, "mail_pass": mail_pass}
            elif field == "console":
                c["console"] = message.text.strip()
            elif field == "region":
                c["region"] = message.text.strip()
            clients[i] = c
            save_db(clients)
            await state.clear()
            await clear_chat(message)
            if c.get("reserve_photo_id"):
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
            else:
                await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
            return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

@dp.message(AddEditClient.edit_games)
async def edit_games_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    games = [line.strip() for line in message.text.strip().split("\n") if line.strip()]
    data = await state.get_data()
    cid = data.get("edit_id")
    clients = load_db()
    for i, c in enumerate(clients):
        if c["id"] == cid:
            c["games"] = games
            clients[i] = c
            save_db(clients)
            await state.clear()
            await clear_chat(message)
            if c.get("reserve_photo_id"):
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
            else:
                await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
            return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

@dp.message(AddEditClient.edit_reserve)
async def edit_reserve_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await clear_chat(message)
        await start_cmd(message, state)
        return
    if message.photo:
        photo_id = message.photo[-1].file_id
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        for i, c in enumerate(clients):
            if c["id"] == cid:
                c["reserve_photo_id"] = photo_id
                clients[i] = c
                save_db(clients)
                await state.clear()
                await clear_chat(message)
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
                return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

# --- –ú–ê–°–¢–ï–† –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–î–ü–ò–°–ö–ò (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é) ---

@dp.message(AddEditClient.edit_subs_total)
async def edit_subs_total(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        for i, c in enumerate(clients):
            if c["id"] == cid:
                c["subscriptions"] = [{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}]
                clients[i] = c
                save_db(clients)
                await state.clear()
                await clear_chat(message)
                if c.get("reserve_photo_id"):
                    await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
                else:
                    await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
                return
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
        await state.clear()
        return
    if message.text not in ("–û–¥–Ω–∞", "–î–≤–µ"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(edit_subs_total=1 if message.text == "–û–¥–Ω–∞" else 2)
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra")],
            [KeyboardButton(text="PS Plus Essential"), KeyboardButton(text="EA Play")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True
    )
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_1_type)

@dp.message(AddEditClient.edit_sub_1_type)
async def edit_sub_1_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential", "EA Play"):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_1_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_1_duration)

@dp.message(AddEditClient.edit_sub_1_duration)
async def edit_sub_1_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    data = await state.get_data()
    sub_1_type = data.get("edit_sub_1_type")
    if (sub_1_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_1_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_1_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_sub_1_start)

@dp.message(AddEditClient.edit_sub_1_start)
async def edit_sub_1_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("edit_sub_1_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("edit_sub_1_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    await state.update_data(edit_sub_1=sub)
    subs_total = data.get("edit_subs_total", 1)
    if subs_total == 2:
        prev = data.get("edit_sub_1_type")
        if prev == "EA Play":
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra"), KeyboardButton(text="PS Plus Essential")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        else:
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="EA Play")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=kb)
        await state.set_state(AddEditClient.edit_sub_2_type)
    else:
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        idx = next((i for i, c in enumerate(clients) if c["id"] == cid), None)
        clients[idx]["subscriptions"] = [sub]
        save_db(clients)
        await state.clear()
        await clear_chat(message)
        if clients[idx].get("reserve_photo_id"):
            await message.answer_photo(clients[idx]["reserve_photo_id"], caption=format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
        else:
            await message.answer(format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
        return

@dp.message(AddEditClient.edit_sub_2_type)
async def edit_sub_2_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    data = await state.get_data()
    prev = data.get("edit_sub_1_type")
    if prev == "EA Play":
        if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential"):
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ PS Plus!")
            return
    else:
        if message.text != "EA Play":
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ EA Play!")
            return
    await state.update_data(edit_sub_2_type=message.text)
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True)
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="1–º"), KeyboardButton(text="12–º")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_2_duration)

@dp.message(AddEditClient.edit_sub_2_duration)
async def edit_sub_2_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    data = await state.get_data()
    sub_2_type = data.get("edit_sub_2_type")
    if (sub_2_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_2_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_2_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_sub_2_start)

@dp.message(AddEditClient.edit_sub_2_start)
async def edit_sub_2_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await start_cmd(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("edit_sub_2_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub1 = data.get("edit_sub_1")
    sub2 = {
        "name": data.get("edit_sub_2_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    subs = [sub1, sub2]
    cid = data.get("edit_id")
    clients = load_db()
    idx = next((i for i, c in enumerate(clients) if c["id"] == cid), None)
    clients[idx]["subscriptions"] = subs
    save_db(clients)
    await state.clear()
    await clear_chat(message)
    if clients[idx].get("reserve_photo_id"):
        await message.answer_photo(clients[idx]["reserve_photo_id"], caption=format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
    else:
        await message.answer(format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
    return

# --- –°–û–•–†–ê–ù–ò–¢–¨ ---

@dp.callback_query(F.data.startswith("save_"))
async def save_client(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await clear_chat(callback.message)
    await callback.message.answer("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu())

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ "–ë–ê–ó–ê" ---
@dp.message(F.text.in_({"–ë–∞–∑–∞", "–±–∞–∑–∞"}))
async def db_menu(message: types.Message, state: FSMContext):
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)"), KeyboardButton(text="–°–∫–æ—Ä–æ –î–†")],
            [KeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏"), KeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç")],
            [KeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –≤ —Ñ–∞–π–ª"), KeyboardButton(text="–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã")],
            [KeyboardButton(text="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞"), KeyboardButton(text="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ],
        resize_keyboard=True
    )
    await state.clear()
    await clear_chat(message)
    await message.answer("–†–∞–∑–¥–µ–ª ¬´–ë–∞–∑–∞¬ª ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=kb)
    await state.set_state(AddEditClient.awaiting_confirm)

# --- –í–´–ì–†–£–ó–ò–¢–¨ –í–°–Æ –ë–ê–ó–£ –í –ß–ê–¢ ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç")
async def db_dump_chat(message: types.Message, state: FSMContext):
    clients = load_db()
    if not clients:
        await message.answer("–ë–∞–∑–∞ –ø—É—Å—Ç–∞!")
    else:
        for client in clients:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
    await db_menu(message, state)

# --- –í–´–ì–†–£–ó–ò–¢–¨ –ë–ê–ó–£ –í –§–ê–ô–õ ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–í—ã–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –≤ —Ñ–∞–π–ª")
async def db_dump_file(message: types.Message, state: FSMContext):
    clients = load_db()
    tmp_path = f"clients_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(tmp_path, "w", encoding="utf-8") as f:
        json.dump(clients, f, ensure_ascii=False, indent=2)
    await bot.send_document(message.chat.id, InputFile(tmp_path))
    os.remove(tmp_path)
    await db_menu(message, state)

# --- –°–î–ï–õ–ê–¢–¨ –ë–≠–ö–ê–ü ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã")
async def make_backup(message: types.Message, state: FSMContext):
    clients = load_db()
    backup_dir = "backups"
    os.makedirs(backup_dir, exist_ok=True)
    fname = f"{backup_dir}/backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(fname, "w", encoding="utf-8") as f:
        json.dump(clients, f, ensure_ascii=False, indent=2)
    await message.answer(f"–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {fname.split('/')[-1]}")
    await db_menu(message, state)

# --- –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –ò–ó –ë–≠–ö–ê–ü–ê ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞")
async def choose_backup(message: types.Message, state: FSMContext):
    backup_dir = "backups"
    if not os.path.exists(backup_dir):
        await message.answer("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤.")
        await db_menu(message, state)
        return
    files = sorted([f for f in os.listdir(backup_dir) if f.endswith(".json")])
    if not files:
        await message.answer("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤.")
        await db_menu(message, state)
        return
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=fn)] for fn in files] + [[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]],
        resize_keyboard=True
    )
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –±—ç–∫–∞–ø –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:", reply_markup=kb)
    await state.set_state(AddEditClient.awaiting_confirm_restore)

@dp.message(AddEditClient.awaiting_confirm_restore)
async def restore_backup(message: types.Message, state: FSMContext):
    fname = message.text.strip()
    if fname == "‚ùå –û—Ç–º–µ–Ω–∞":
        await db_menu(message, state)
        return
    backup_path = f"backups/{fname}"
    if not os.path.exists(backup_path):
        await message.answer("–ë—ç–∫–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        await db_menu(message, state)
        return
    with open(backup_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    save_db(data)
    await message.answer("–ë–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –±—ç–∫–∞–ø–∞.")
    await db_menu(message, state)

# --- –û–ß–ò–°–¢–ò–¢–¨ –ë–ê–ó–£ ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É")
async def ask_clear_db(message: types.Message, state: FSMContext):
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë"), KeyboardButton(text="–ù–µ—Ç, –æ—Ç–º–µ–Ω–∞")],
        ], resize_keyboard=True
    )
    await message.answer("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–Æ –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤?", reply_markup=kb)
    await state.set_state(AddEditClient.awaiting_confirm_clear)

@dp.message(AddEditClient.awaiting_confirm_clear)
async def clear_db_confirm(message: types.Message, state: FSMContext):
    if message.text == "–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë":
        save_db([])
        await message.answer("–ë–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é.")
    else:
        await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await db_menu(message, state)

# --- –ö–õ–ò–ï–ù–¢–´ –ë–ï–ó –ü–û–î–ü–ò–°–ö–ò ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏")
async def dump_no_subs(message: types.Message, state: FSMContext):
    clients = load_db()
    found = []
    for c in clients:
        if not c.get("subscriptions") or (c.get("subscriptions")[0] and c["subscriptions"][0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"):
            found.append(c)
    if not found:
        await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏!")
    else:
        for client in found:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
    await db_menu(message, state)

# --- –ö–õ–ò–ï–ù–¢–´ –° –ü–û–î–ü–ò–°–ö–û–ô –ó–ê–ö–ê–ù–ß–ò–í–ê–Æ–¢–°–Ø 7 –î–ù–ï–ô ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)")
async def dump_expiring_subs(message: types.Message, state: FSMContext):
    clients = load_db()
    now = datetime.now()
    week = timedelta(days=7)
    found = []
    for c in clients:
        for sub in c.get("subscriptions", []):
            try:
                end = datetime.strptime(sub.get("end", ""), "%d.%m.%Y")
                if 0 <= (end - now).days <= 7:
                    found.append(c)
                    break
            except: continue
    if not found:
        await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π!")
    else:
        for client in found:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
    await db_menu(message, state)

# --- –ö–õ–ò–ï–ù–¢–´ –° –î–† –í –¢–ï–ß–ï–ù–ò–ï 7 –î–ù–ï–ô ---
@dp.message(AddEditClient.awaiting_confirm, F.text == "–°–∫–æ—Ä–æ –î–†")
async def dump_soon_birthdays(message: types.Message, state: FSMContext):
    clients = load_db()
    now = datetime.now()
    week = timedelta(days=7)
    found = []
    for c in clients:
        bdate = c.get("birth_date", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        if bdate and bdate != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
            try:
                bd = datetime.strptime(bdate, "%d.%m.%Y").replace(year=now.year)
                days_to_bd = (bd - now).days
                if 0 <= days_to_bd <= 7:
                    found.append(c)
            except: continue
    if not found:
        await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π!")
    else:
        for client in found:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
    await db_menu(message, state)

# --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
@dp.message(F.text.in_({"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"}))
async def stat_menu(message: types.Message, state: FSMContext):
    clients = load_db()
    total = len(clients)
    with_subs = 0
    two_subs = 0
    deluxe = extra = essential = ea = 0
    no_sub = 0
    games_count = 0
    regions = {"—É–∫—Ä": 0, "—Ç—É—Ä": 0, "(–ø–æ–ª—å—à–∞)": 0, "(–±—Ä–∏—Ç–∞–Ω–∏—è)": 0, "–¥—Ä—É–≥–æ–π": 0}
    expiring = 0
    soon_bd = 0
    now = datetime.now()
    for c in clients:
        if c.get("games"):
            games_count += len(c["games"])
        reg = c.get("region", "–¥—Ä—É–≥–æ–π")
        if reg in regions:
            regions[reg] += 1
        else:
            regions["–¥—Ä—É–≥–æ–π"] += 1
        subs = c.get("subscriptions", [])
        if not subs or (subs[0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"):
            no_sub += 1
        else:
            with_subs += 1
            if len(subs) == 2:
                two_subs += 1
            for sub in subs:
                n = sub.get("name")
                if n == "PS Plus Deluxe":
                    deluxe += 1
                elif n == "PS Plus Extra":
                    extra += 1
                elif n == "PS Plus Essential":
                    essential += 1
                elif n == "EA Play":
                    ea += 1
                try:
                    end = datetime.strptime(sub.get("end", ""), "%d.%m.%Y")
                    if 0 <= (end - now).days <= 7:
                        expiring += 1
                except: pass
        bdate = c.get("birth_date", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        if bdate and bdate != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
            try:
                bd = datetime.strptime(bdate, "%d.%m.%Y").replace(year=now.year)
                if 0 <= (bd - now).days <= 7:
                    soon_bd += 1
            except: pass
    stat_text = (
        f"<b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CRM</b>\n\n"
        f"üë§ –ö–ª–∏–µ–Ω—Ç–æ–≤: {total}\n"
        f"‚úâÔ∏è –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏: {no_sub}\n"
        f"üí≥ –° –ø–æ–¥–ø–∏—Å–∫–∞–º–∏: {with_subs}\n"
        f"‚Äî PS Plus Deluxe: {deluxe}\n"
        f"‚Äî PS Plus Extra: {extra}\n"
        f"‚Äî PS Plus Essential: {essential}\n"
        f"‚Äî EA Play: {ea}\n"
        f"üîÅ –î–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏: {two_subs}\n\n"
        f"üåç –†–µ–≥–∏–æ–Ω—ã:\n"
        f"—É–∫—Ä: {regions['—É–∫—Ä']}\n"
        f"—Ç—É—Ä: {regions['—Ç—É—Ä']}\n"
        f"(–ø–æ–ª—å—à–∞): {regions['(–ø–æ–ª—å—à–∞)']}\n"
        f"(–±—Ä–∏—Ç–∞–Ω–∏—è): {regions['(–±—Ä–∏—Ç–∞–Ω–∏—è)']}\n"
        f"–¥—Ä—É–≥–æ–π: {regions['–¥—Ä—É–≥–æ–π']}\n\n"
        f"üéÆ –û—Ñ–æ—Ä–º–ª–µ–Ω–æ –∏–≥—Ä: {games_count}\n"
        f"‚è≥ –ü–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫–∞—é—Ç (7 –¥–Ω–µ–π): {expiring}\n"
        f"üéÇ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Å–∫–æ—Ä–æ: {soon_bd}\n"
    )
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)"), KeyboardButton(text="–°–∫–æ—Ä–æ –î–†")],
            [KeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏"), KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ],
        resize_keyboard=True
    )
    await state.clear()
    await clear_chat(message)
    await message.answer(stat_text, reply_markup=kb)
    await state.set_state(AddEditClient.awaiting_confirm)

# --- –û–¢–ú–ï–ù–ê –í –õ–Æ–ë–û–ú –ú–ï–°–¢–ï ---
@dp.message(F.text == "‚ùå –û—Ç–º–µ–Ω–∞")
async def cancel_anywhere(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await start_cmd(message, state)

# --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê ---

@dp.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞")
async def add_start(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ Telegram (@username):", 
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.contact)

@dp.message(AddEditClient.contact)
async def step_contact(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    await state.update_data(contact=message.text.strip())
    await message.answer("–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –µ—Å—Ç—å?", 
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
    await state.set_state(AddEditClient.birthdate_yesno)

@dp.message(AddEditClient.birthdate_yesno)
async def step_birthdate_ask(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(birth_date="–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        await ask_account(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):",
            reply_markup=ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.birthdate)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.birthdate)
async def step_birthdate(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    try:
        datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    await state.update_data(birth_date=message.text.strip())
    await ask_account(message, state)

async def ask_account(message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏:\n1. –õ–æ–≥–∏–Ω\n2. –ü–∞—Ä–æ–ª—å\n3. –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)\n\n–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.account)

@dp.message(AddEditClient.account)
async def step_account(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    rows = message.text.strip().split("\n")
    login = rows[0].strip() if len(rows) > 0 else ""
    password = rows[1].strip() if len(rows) > 1 else ""
    mail_pass = rows[2].strip() if len(rows) > 2 else ""
    await state.update_data(account={"login": login, "password": password, "mail_pass": mail_pass})
    await message.answer("–í—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞:", reply_markup=region_btns())
    await state.set_state(AddEditClient.region)

@dp.message(AddEditClient.region)
async def step_region(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text not in ("—É–∫—Ä", "—Ç—É—Ä", "–¥—Ä—É–≥–æ–π", "(–ø–æ–ª—å—à–∞)", "(–±—Ä–∏—Ç–∞–Ω–∏—è)"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(region=message.text)
    await message.answer("–ö–∞–∫–∞—è –∫–æ–Ω—Å–æ–ª—å?", reply_markup=console_btns())
    await state.set_state(AddEditClient.console)

@dp.message(AddEditClient.console)
async def step_console(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text not in ("PS4", "PS5", "PS4/PS5"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(console=message.text)
    await message.answer("–ï—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.subscriptions_yesno)

@dp.message(AddEditClient.subscriptions_yesno)
async def step_subs_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(subscriptions=[{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}])
        await ask_games(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–°–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫?", reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–û–¥–Ω–∞"), KeyboardButton(text="–î–≤–µ")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
        await state.set_state(AddEditClient.subscriptions_count)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.subscriptions_count)
async def step_subs_count(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–û–¥–Ω–∞":
        await state.update_data(subs_total=1)
        await sub_select(message, state, sub_num=1, only_one=True)
        return
    if message.text == "–î–≤–µ":
        await state.update_data(subs_total=2)
        await sub_select(message, state, sub_num=1, only_one=False)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

async def sub_select(message, state: FSMContext, sub_num=1, only_one=False):
    if sub_num == 1:
        kb = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra")],
                [KeyboardButton(text="PS Plus Essential"), KeyboardButton(text="EA Play")],
                [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True
        )
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=kb)
        await state.set_state(AddEditClient.sub_1_type)
    else:
        data = await state.get_data()
        prev = data.get("sub_1_type")
        kb = None
        if prev == "EA Play":
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra"), KeyboardButton(text="PS Plus Essential")],
                    [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        else:
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="EA Play")],
                    [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=kb)
        await state.set_state(AddEditClient.sub_2_type)

@dp.message(AddEditClient.sub_1_type)
async def sub1_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        await state.update_data(subscriptions=[{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}])
        await ask_games(message, state)
        return
    if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential", "EA Play"):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_1_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.sub_1_duration)

@dp.message(AddEditClient.sub_1_duration)
async def sub1_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    sub_1_type = data.get("sub_1_type")
    if (sub_1_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_1_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_1_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.sub_1_start)

@dp.message(AddEditClient.sub_1_start)
async def sub1_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("sub_1_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("sub_1_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    await state.update_data(sub_1=sub)
    subs_total = data.get("subs_total", 1)
    if subs_total == 2:
        await sub_select(message, state, sub_num=2)
    else:
        await state.update_data(subscriptions=[sub])
        await ask_games(message, state)

@dp.message(AddEditClient.sub_2_type)
async def sub2_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        data = await state.get_data()
        await state.update_data(subscriptions=[data.get("sub_1")])
        await ask_games(message, state)
        return
    data = await state.get_data()
    prev = data.get("sub_1_type")
    if prev == "EA Play":
        if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential"):
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ PS Plus!")
            return
    else:
        if message.text != "EA Play":
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ EA Play!")
            return
    await state.update_data(sub_2_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.sub_2_duration)

@dp.message(AddEditClient.sub_2_duration)
async def sub2_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    sub_2_type = data.get("sub_2_type")
    if (sub_2_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_2_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(sub_2_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.sub_2_start)

@dp.message(AddEditClient.sub_2_start)
async def sub2_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("sub_2_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("sub_2_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    subs = [data.get("sub_1"), sub]
    await state.update_data(sub_2=sub, subscriptions=subs)
    await ask_games(message, state)

# --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò–ì–†–´, –†–ï–ó–ï–†–í–ù–´–ï –ö–û–î–´, –§–ò–ù–ê–õ ---

async def ask_games(message, state: FSMContext):
    await message.answer("–û—Ñ–æ—Ä–º–ª–µ–Ω—ã –∏–≥—Ä—ã?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.games_yesno)

@dp.message(AddEditClient.games_yesno)
async def games_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(games=[])
        await ask_reserve(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–í–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):", 
            reply_markup=ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.games_input)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.games_input)
async def games_input(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    games = [line.strip() for line in message.text.strip().split("\n") if line.strip()]
    await state.update_data(games=games)
    await ask_reserve(message, state)

async def ask_reserve(message, state: FSMContext):
    await message.answer("–ï—Å—Ç—å –ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–¥—ã?", reply_markup=ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True))
    await state.set_state(AddEditClient.reserve_yesno)

@dp.message(AddEditClient.reserve_yesno)
async def reserve_yesno(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç":
        await state.update_data(reserve_photo_id=None)
        await finish_client(message, state)
        return
    if message.text == "–î–∞":
        await message.answer("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç (—Ñ–æ—Ç–æ):", reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.reserve_photo)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.reserve_photo)
async def reserve_photo(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.photo:
        file_id = message.photo[-1].file_id
        await state.update_data(reserve_photo_id=file_id)
        await finish_client(message, state)
    else:
        await message.answer("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ!")

async def finish_client(message: types.Message, state: FSMContext):
    data = await state.get_data()
    client = {
        "id": get_next_client_id(load_db()),
        "contact": data.get("contact", ""),
        "birth_date": data.get("birth_date", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"),
        "account": data.get("account", {}),
        "region": data.get("region", ""),
        "console": data.get("console", ""),
        "subscriptions": data.get("subscriptions", [{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}]),
        "games": data.get("games", []),
        "reserve_photo_id": data.get("reserve_photo_id", None),
    }
    save_new_client(client)
    await state.clear()
    await clear_chat(message)
    if client.get("reserve_photo_id"):
        await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0], reply_markup=edit_keyboard(client))
    else:
        await message.answer(format_card(client)[0], reply_markup=edit_keyboard(client))

# --- –ü–û–ò–°–ö –ö–õ–ò–ï–ù–¢–ê ---
@dp.message(F.text == "üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞")
async def search_start(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ (–Ω–æ–º–µ—Ä, –ª–æ–≥–∏–Ω, –∏–≥—Ä–∞ –∏ —Ç.–¥.):",
        reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_choose)

@dp.message(AddEditClient.edit_choose)
async def search_choose(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    query = message.text.strip()
    clients = find_clients(query)
    if not clients:
        await message.answer("–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await start_cmd(message, state)
        return
    await state.clear()
    await clear_chat(message)
    for client in clients:
        if client.get("reserve_photo_id"):
            await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0], reply_markup=edit_keyboard(client))
        else:
            await message.answer(format_card(client)[0], reply_markup=edit_keyboard(client))

# --- –ò–ù–õ–ê–ô–ù-–ö–ù–û–ü–ö–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
@dp.callback_query(F.data.startswith("edit_"))
async def edit_fields(callback: types.CallbackQuery, state: FSMContext):
    act, field, cid = callback.data.split("_", 2)
    cid = int(cid)
    clients = load_db()
    client = next((c for c in clients if c["id"] == cid), None)
    if not client:
        await callback.message.answer("–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    await state.clear()
    await state.update_data(edit_id=cid)
    if field == "contact":
        await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ Telegram:", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="contact")
        return
    if field == "birth":
        await callback.message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥) –∏–ª–∏ '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç':", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="birth_date")
        return
    if field == "account":
        await callback.message.answer("–í–≤–µ–¥–∏:\n1. –õ–æ–≥–∏–Ω\n2. –ü–∞—Ä–æ–ª—å\n3. –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)\n\n–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
            reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="account")
        return
    if field == "console":
        await callback.message.answer("–í—ã–±–µ—Ä–∏ –∫–æ–Ω—Å–æ–ª—å:", reply_markup=console_btns())
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="console")
        return
    if field == "region":
        await callback.message.answer("–í—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞:", reply_markup=region_btns())
        await state.set_state(AddEditClient.edit_input)
        await state.update_data(edit_field="region")
        return
    if field == "reserve":
        await callback.message.answer("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ —Ä–µ–∑–µ—Ä–≤-–∫–æ–¥–æ–≤:", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_reserve)
        return
    if field == "sub":
        await callback.message.answer("–°–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫?", reply_markup=ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–û–¥–Ω–∞"), KeyboardButton(text="–î–≤–µ")],
                [KeyboardButton(text="–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_subs_total)
        return
    if field == "games":
        await callback.message.answer("–í–≤–µ–¥–∏ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):", reply_markup=ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
        await state.set_state(AddEditClient.edit_games)
        return

# --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–õ–ï–ô ---
@dp.message(AddEditClient.edit_input)
async def edit_input_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    cid = data.get("edit_id")
    field = data.get("edit_field")
    clients = load_db()
    for i, c in enumerate(clients):
        if c["id"] == cid:
            if field == "contact":
                c["contact"] = message.text.strip()
            elif field == "birth_date":
                c["birth_date"] = message.text.strip()
            elif field == "account":
                rows = message.text.strip().split("\n")
                login = rows[0].strip() if len(rows) > 0 else ""
                password = rows[1].strip() if len(rows) > 1 else ""
                mail_pass = rows[2].strip() if len(rows) > 2 else ""
                c["account"] = {"login": login, "password": password, "mail_pass": mail_pass}
            elif field == "console":
                c["console"] = message.text.strip()
            elif field == "region":
                c["region"] = message.text.strip()
            clients[i] = c
            save_db(clients)
            await state.clear()
            await clear_chat(message)
            if c.get("reserve_photo_id"):
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
            else:
                await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
            return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

@dp.message(AddEditClient.edit_games)
async def edit_games_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    games = [line.strip() for line in message.text.strip().split("\n") if line.strip()]
    data = await state.get_data()
    cid = data.get("edit_id")
    clients = load_db()
    for i, c in enumerate(clients):
        if c["id"] == cid:
            c["games"] = games
            clients[i] = c
            save_db(clients)
            await state.clear()
            await clear_chat(message)
            if c.get("reserve_photo_id"):
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
            else:
                await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
            return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

@dp.message(AddEditClient.edit_reserve)
async def edit_reserve_handler(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.photo:
        photo_id = message.photo[-1].file_id
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        for i, c in enumerate(clients):
            if c["id"] == cid:
                c["reserve_photo_id"] = photo_id
                clients[i] = c
                save_db(clients)
                await state.clear()
                await clear_chat(message)
                await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
                return
    await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
    await state.clear()

# --- –ú–ê–°–¢–ï–† –ü–û–î–ü–ò–°–ö–ò (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫) ---
@dp.message(AddEditClient.edit_subs_total)
async def edit_subs_total(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text == "–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏":
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        for i, c in enumerate(clients):
            if c["id"] == cid:
                c["subscriptions"] = [{"name": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}]
                clients[i] = c
                save_db(clients)
                await state.clear()
                await clear_chat(message)
                if c.get("reserve_photo_id"):
                    await message.answer_photo(c["reserve_photo_id"], caption=format_card(c)[0], reply_markup=edit_keyboard(c))
                else:
                    await message.answer(format_card(c)[0], reply_markup=edit_keyboard(c))
                return
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")
        await state.clear()
        return
    if message.text not in ("–û–¥–Ω–∞", "–î–≤–µ"):
        await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")
        return
    await state.update_data(edit_subs_total=1 if message.text == "–û–¥–Ω–∞" else 2)
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra")],
            [KeyboardButton(text="PS Plus Essential"), KeyboardButton(text="EA Play")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True
    )
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_1_type)

@dp.message(AddEditClient.edit_sub_1_type)
async def edit_sub_1_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential", "EA Play"):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_1_type=message.text)
    kb = None
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    else:
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")], [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_1_duration)

@dp.message(AddEditClient.edit_sub_1_duration)
async def edit_sub_1_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    sub_1_type = data.get("edit_sub_1_type")
    if (sub_1_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_1_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_1_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_sub_1_start)

@dp.message(AddEditClient.edit_sub_1_start)
async def edit_sub_1_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("edit_sub_1_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub = {
        "name": data.get("edit_sub_1_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    await state.update_data(edit_sub_1=sub)
    subs_total = data.get("edit_subs_total", 1)
    if subs_total == 2:
        prev = data.get("edit_sub_1_type")
        if prev == "EA Play":
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="PS Plus Deluxe"), KeyboardButton(text="PS Plus Extra"), KeyboardButton(text="PS Plus Essential")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        else:
            kb = ReplyKeyboardMarkup(
                keyboard=[
                    [KeyboardButton(text="EA Play")],
                    [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
                ], resize_keyboard=True)
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=kb)
        await state.set_state(AddEditClient.edit_sub_2_type)
    else:
        data = await state.get_data()
        cid = data.get("edit_id")
        clients = load_db()
        idx = next((i for i, c in enumerate(clients) if c["id"] == cid), None)
        clients[idx]["subscriptions"] = [sub]
        save_db(clients)
        await state.clear()
        await clear_chat(message)
        if clients[idx].get("reserve_photo_id"):
            await message.answer_photo(clients[idx]["reserve_photo_id"], caption=format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
        else:
            await message.answer(format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
        return

@dp.message(AddEditClient.edit_sub_2_type)
async def edit_sub_2_type(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    prev = data.get("edit_sub_1_type")
    if prev == "EA Play":
        if message.text not in ("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential"):
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ PS Plus!")
            return
    else:
        if message.text != "EA Play":
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ EA Play!")
            return
    await state.update_data(edit_sub_2_type=message.text)
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="1–º"), KeyboardButton(text="3–º"), KeyboardButton(text="12–º")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ], resize_keyboard=True)
    if message.text == "EA Play":
        kb = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="1–º"), KeyboardButton(text="12–º")],
                [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
            ], resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:", reply_markup=kb)
    await state.set_state(AddEditClient.edit_sub_2_duration)

@dp.message(AddEditClient.edit_sub_2_duration)
async def edit_sub_2_duration(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    data = await state.get_data()
    sub_2_type = data.get("edit_sub_2_type")
    if (sub_2_type == "EA Play" and message.text not in ("1–º", "12–º")) or \
       (sub_2_type != "EA Play" and message.text not in ("1–º", "3–º", "12–º")):
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∫–Ω–æ–ø–∫–æ–π!")
        return
    await state.update_data(edit_sub_2_duration=message.text)
    await message.answer("–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]], resize_keyboard=True))
    await state.set_state(AddEditClient.edit_sub_2_start)

@dp.message(AddEditClient.edit_sub_2_start)
async def edit_sub_2_start(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    try:
        start = datetime.strptime(message.text.strip(), "%d.%m.%Y")
    except:
        await message.answer("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –¥–¥.–º–º.–≥–≥–≥–≥")
        return
    data = await state.get_data()
    duration = data.get("edit_sub_2_duration")
    months = int(duration.replace("–º", ""))
    try:
        year = start.year + (start.month - 1 + months) // 12
        month = (start.month - 1 + months) % 12 + 1
        day = start.day
        end = start.replace(year=year, month=month, day=day)
    except:
        end = start + timedelta(days=months*30)
    sub1 = data.get("edit_sub_1")
    sub2 = {
        "name": data.get("edit_sub_2_type"),
        "duration": duration,
        "start": message.text.strip(),
        "end": end.strftime("%d.%m.%Y")
    }
    subs = [sub1, sub2]
    cid = data.get("edit_id")
    clients = load_db()
    idx = next((i for i, c in enumerate(clients) if c["id"] == cid), None)
    clients[idx]["subscriptions"] = subs
    save_db(clients)
    await state.clear()
    await clear_chat(message)
    if clients[idx].get("reserve_photo_id"):
        await message.answer_photo(clients[idx]["reserve_photo_id"], caption=format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
    else:
        await message.answer(format_card(clients[idx])[0], reply_markup=edit_keyboard(clients[idx]))
    return

# --- –°–û–•–†–ê–ù–ò–¢–¨ ---
@dp.callback_query(F.data.startswith("save_"))
async def save_client(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await clear_chat(callback.message)
    await callback.message.answer("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu())

# --- –§–£–ù–ö–¶–ò–Ø –û–¢–ú–ï–ù–´ ---
async def cancel_anywhere(message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await start_cmd(message, state)

# --- –†–ê–ó–î–ï–õ "–ë–ê–ó–ê", –°–¢–ê–¢–ò–°–¢–ò–ö–ê, –ë–≠–ö–ê–ü–´, –û–ß–ò–°–¢–ö–ê ---

from glob import glob

def get_backups():
    return sorted(glob("clients_db_*.json"), reverse=True)

@dp.message(F.text.in_({"–ë–∞–∑–∞", "–±–∞–∑–∞"}))
async def base_menu(message: types.Message, state: FSMContext):
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [
                KeyboardButton(text="–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)"),
                KeyboardButton(text="–°–∫–æ—Ä–æ –î–† (7–¥)")
            ],
            [
                KeyboardButton(text="–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏"),
                KeyboardButton(text="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç")
            ],
            [
                KeyboardButton(text="–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã"),
                KeyboardButton(text="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞")
            ],
            [
                KeyboardButton(text="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É"),
                KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")
            ]
        ],
        resize_keyboard=True
    )
    stat_text = make_statistics()
    await message.answer(stat_text, reply_markup=kb)
    await state.set_state(AddEditClient.awaiting_confirm)

def make_statistics():
    clients = load_db()
    n_clients = len(clients)
    n_no_subs = sum(1 for c in clients if not c.get("subscriptions") or c["subscriptions"][0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    n_with_subs = n_clients - n_no_subs

    subs_types = {
        "PS Plus Deluxe": 0,
        "PS Plus Extra": 0,
        "PS Plus Essential": 0,
        "EA Play": 0
    }
    two_subs = 0
    for c in clients:
        subs = c.get("subscriptions", [])
        if len(subs) > 1:
            two_subs += 1
        for sub in subs:
            if sub.get("name") in subs_types:
                subs_types[sub["name"]] += 1

    region_map = {"—É–∫—Ä": 0, "—Ç—É—Ä": 0, "(–ø–æ–ª—å—à–∞)": 0, "(–±—Ä–∏—Ç–∞–Ω–∏—è)": 0, "–¥—Ä—É–≥–æ–π": 0}
    for c in clients:
        reg = c.get("region", "").lower()
        if reg in region_map:
            region_map[reg] += 1
        else:
            region_map["–¥—Ä—É–≥–æ–π"] += 1

    n_games = sum(1 for c in clients if c.get("games"))

    # –ø–æ–¥–ø–∏—Å–∫–∏ –∫–æ–Ω—á–∞—é—Ç—Å—è –≤ 7 –¥–Ω–µ–π
    soon_subs = 0
    now = datetime.now()
    for c in clients:
        for sub in c.get("subscriptions", []):
            try:
                end = datetime.strptime(sub.get("end", ""), "%d.%m.%Y")
                if 0 <= (end - now).days <= 7:
                    soon_subs += 1
            except: continue

    # –î–† –≤ 7 –¥–Ω–µ–π
    soon_bd = 0
    for c in clients:
        bdate = c.get("birth_date")
        if bdate and bdate != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
            try:
                bd = datetime.strptime(bdate, "%d.%m.%Y")
                bd_this_year = bd.replace(year=now.year)
                days = (bd_this_year - now).days
                if 0 <= days <= 7:
                    soon_bd += 1
            except: continue

    txt = f"<b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CRM</b>\n\n"
    txt += f"üë§ –ö–ª–∏–µ–Ω—Ç–æ–≤: {n_clients}\n"
    txt += f"‚úâÔ∏è –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏: {n_no_subs}\n"
    txt += f"üí≥ –° –ø–æ–¥–ø–∏—Å–∫–∞–º–∏: {n_with_subs}\n"
    for k, v in subs_types.items():
        txt += f"‚Äî {k}: {v}\n"
    txt += f"üîÅ –î–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏: {two_subs}\n\n"
    txt += f"üåç –†–µ–≥–∏–æ–Ω—ã:\n"
    for reg in ["—É–∫—Ä", "—Ç—É—Ä", "(–ø–æ–ª—å—à–∞)", "(–±—Ä–∏—Ç–∞–Ω–∏—è)", "–¥—Ä—É–≥–æ–π"]:
        txt += f"{reg}: {region_map[reg]}\n"
    txt += f"\nüéÆ –û—Ñ–æ—Ä–º–ª–µ–Ω–æ –∏–≥—Ä: {n_games}\n"
    txt += f"‚è≥ –ü–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫–∞—é—Ç (7 –¥–Ω–µ–π): {soon_subs}\n"
    txt += f"üéÇ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Å–∫–æ—Ä–æ: {soon_bd}\n"
    return txt

@dp.message(AddEditClient.awaiting_confirm)
async def base_buttons(message: types.Message, state: FSMContext):
    text = message.text
    if text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return

    if text == "–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å—é –±–∞–∑—É –≤ —á–∞—Ç":
        clients = load_db()
        if not clients:
            await message.answer("–ë–∞–∑–∞ –ø—É—Å—Ç–∞!")
            return
        for client in clients:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
        return

    if text == "–°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –±–∞–∑—ã":
        now_str = datetime.now().strftime("%Y%m%d_%H%M%S")
        clients = load_db()
        fname = f"clients_db_{now_str}.json"
        with open(fname, "w", encoding="utf-8") as f:
            json.dump(clients, f, ensure_ascii=False, indent=2)
        await message.answer(f"–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {fname}")
        return

    if text == "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞":
        backups = get_backups()
        if not backups:
            await message.answer("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤.")
            return
        kb = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text=os.path.basename(bf))] for bf in backups] + [[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]],
            resize_keyboard=True
        )
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –±—ç–∫–∞–ø –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:", reply_markup=kb)
        await state.set_state(AddEditClient.awaiting_confirm_restore)
        return

    if text == "–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É":
        kb = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="–î–∞"), KeyboardButton(text="–ù–µ—Ç")]
            ], resize_keyboard=True
        )
        await message.answer("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –±–∞–∑—É?", reply_markup=kb)
        await state.set_state(AddEditClient.awaiting_confirm_delete)
        return

    if text == "–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏":
        clients = load_db()
        filtered = [c for c in clients if not c.get("subscriptions") or c["subscriptions"][0].get("name") == "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"]
        if not filtered:
            await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏.")
            return
        for client in filtered:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
        return

    if text == "–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ (7–¥)":
        clients = load_db()
        now = datetime.now()
        res = []
        for c in clients:
            for sub in c.get("subscriptions", []):
                try:
                    end = datetime.strptime(sub.get("end", ""), "%d.%m.%Y")
                    if 0 <= (end - now).days <= 7:
                        res.append(c)
                except: continue
        if not res:
            await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∏—Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π.")
            return
        for client in res:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
        return

    if text == "–°–∫–æ—Ä–æ –î–† (7–¥)":
        clients = load_db()
        now = datetime.now()
        res = []
        for c in clients:
            bdate = c.get("birth_date")
            if bdate and bdate != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
                try:
                    bd = datetime.strptime(bdate, "%d.%m.%Y")
                    bd_this_year = bd.replace(year=now.year)
                    days = (bd_this_year - now).days
                    if 0 <= days <= 7:
                        res.append(c)
                except: continue
        if not res:
            await message.answer("–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –î–† –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π.")
            return
        for client in res:
            if client.get("reserve_photo_id"):
                await message.answer_photo(client["reserve_photo_id"], caption=format_card(client)[0])
            else:
                await message.answer(format_card(client)[0])
        return

@dp.message(AddEditClient.awaiting_confirm_delete)
async def confirm_delete(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞" or message.text == "–ù–µ—Ç":
        await cancel_anywhere(message, state)
        return
    if message.text == "–î–∞":
        save_db([])
        await message.answer("–ë–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞.")
        await start_cmd(message, state)
        return
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É!")

@dp.message(AddEditClient.awaiting_confirm_restore)
async def confirm_restore(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_anywhere(message, state)
        return
    fname = message.text
    if not os.path.exists(fname):
        await message.answer("–¢–∞–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await start_cmd(message, state)
        return
    with open(fname, "r", encoding="utf-8") as f:
        try:
            clients = json.load(f)
            save_db(clients)
            await message.answer("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
        except:
            await message.answer("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞.")
    await start_cmd(message, state)

# --- –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –û –ö–û–ù–¶–ï –ü–û–î–ü–ò–°–ö–ò –ò –î–ù–Ø–• –†–û–ñ–î–ï–ù–ò–Ø ---

async def notify_soon_subs_and_bd():
    clients = load_db()
    now = datetime.now()
    soon_subs = []
    soon_bd = []
    for c in clients:
        # –ø–æ–¥–ø–∏—Å–∫–∏ –∑–∞ –¥–µ–Ω—å –¥–æ –∫–æ–Ω—Ü–∞
        for sub in c.get("subscriptions", []):
            try:
                end = datetime.strptime(sub.get("end", ""), "%d.%m.%Y")
                if (end - now).days == 1:
                    soon_subs.append((c, sub))
            except:
                continue
        # –î–† —Å–µ–≥–æ–¥–Ω—è
        bdate = c.get("birth_date")
        if bdate and bdate != "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç":
            try:
                bd = datetime.strptime(bdate, "%d.%m.%Y")
                bd_this_year = bd.replace(year=now.year)
                if (bd_this_year - now).days == 0:
                    soon_bd.append(c)
            except:
                continue

    if soon_subs:
        for c, sub in soon_subs:
            txt, _ = format_card(c)
            await bot.send_message(
                ADMIN_ID, f"‚ö†Ô∏è <b>–ó–∞–≤—Ç—Ä–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∞:</b>\n{sub['name']} ({sub['end']})\n\n{txt}",
                reply_markup=edit_keyboard(c)
            )
    if soon_bd:
        for c in soon_bd:
            txt, _ = format_card(c)
            await bot.send_message(
                ADMIN_ID, f"üéâ <b>–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É –∫–ª–∏–µ–Ω—Ç–∞:</b>\n\n{txt}",
                reply_markup=edit_keyboard(c)
            )

# --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ë–≠–ö–ê–ü (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏) ---
def auto_backup():
    now_str = datetime.now().strftime("%Y%m%d_%H%M%S")
    clients = load_db()
    fname = f"clients_db_{now_str}.json"
    with open(fname, "w", encoding="utf-8") as f:
        json.dump(clients, f, ensure_ascii=False, indent=2)

def start_scheduler():
    scheduler.add_job(notify_soon_subs_and_bd, "cron", hour=9, minute=0)  # 9:00 –ø–æ —Å–µ—Ä–≤–µ—Ä—É
    scheduler.add_job(auto_backup, "cron", hour=3, minute=0)  # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å 3:00

# --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–¢–ú–ï–ù–ê –ù–ê –õ–Æ–ë–û–ô –ö–ù–û–ü–ö–ï "–û–¢–ú–ï–ù–ê" ---
async def cancel_anywhere(message: types.Message, state: FSMContext):
    await state.clear()
    await clear_chat(message)
    await start_cmd(message, state)

# --- –ó–ê–ü–£–°–ö –ë–û–¢–ê ---
async def main():
    start_scheduler()
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())